{% extends "base.html" %}

{% block fonts %}
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500;1,600&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Instrument+Serif:ital@0;1&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block extrahead %}
  <!-- Open Graph -->
  <meta property="og:title" content="{{ page.title }} | {{ config.site_name }}" />
  <meta property="og:description" content="{{ config.site_description }}" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="{{ page.canonical_url }}" />
  <meta property="og:site_name" content="{{ config.site_name }}" />
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@sauravbhats" />
  <meta name="twitter:creator" content="@sauravbhats" />
  <meta name="twitter:title" content="{{ page.title }} | {{ config.site_name }}" />
  <meta name="twitter:description" content="{{ config.site_description }}" />

  <!-- Force Mermaid shadow roots to open so our post-processor can access SVG internals.
       Must run before Material's bundle.js which renders Mermaid with closed shadow DOM. -->
  <script>
    (function() {
      var orig = Element.prototype.attachShadow;
      Element.prototype.attachShadow = function(init) {
        if (this.classList && this.classList.contains('mermaid')) {
          init = Object.assign({}, init, { mode: 'open' });
        }
        return orig.call(this, init);
      };
    })();
  </script>
{% endblock %}

{% block content %}
  <!-- Sidebar toggle buttons -->
  <button class="bp-sidebar-toggle bp-toggle-left" id="bp-toggle-left" title="Toggle navigation  [" aria-label="Toggle navigation">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>
  <button class="bp-sidebar-toggle bp-toggle-right" id="bp-toggle-right" title="Toggle table of contents  ]" aria-label="Toggle table of contents">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </button>

  <script>
    (function() {
      var left = document.getElementById('bp-toggle-left');
      var right = document.getElementById('bp-toggle-right');
      var body = document.body;

      function toggleLeft() {
        body.classList.toggle('bp-left-collapsed');
        localStorage.setItem('bp-left-collapsed', body.classList.contains('bp-left-collapsed') ? '1' : '0');
      }
      function toggleRight() {
        body.classList.toggle('bp-right-collapsed');
        localStorage.setItem('bp-right-collapsed', body.classList.contains('bp-right-collapsed') ? '1' : '0');
      }

      // FIX #2: Default is OPEN — only collapse if user explicitly chose it
      // (no restore on first visit; sidebars start expanded)
      if (localStorage.getItem('bp-left-collapsed') === '1') body.classList.add('bp-left-collapsed');
      if (localStorage.getItem('bp-right-collapsed') === '1') body.classList.add('bp-right-collapsed');

      left.addEventListener('click', toggleLeft);
      right.addEventListener('click', toggleRight);

      // Keyboard: [ = toggle left, ] = toggle right
      document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
        if (e.key === '[') toggleLeft();
        if (e.key === ']') toggleRight();
      });
    })();
  </script>

  {{ super() }}

  <!-- Mermaid dual-mode color post-processor.
       Markdown contains hardcoded dark-mode hex (works on GitHub too).
       This JS swaps fills/strokes/text to soft pastels in light mode.
       Material 9.x renders Mermaid inside shadow DOM; the extrahead
       script forces mode:"open" so we can access SVG internals here. -->
  <script>
    (function() {
      // ── Dark-mode hex → semantic group ──────────────────────────
      var FILL_MAP = {
        '#1e6fa5':'info',
        '#1a8a52':'success',
        '#c77d0a':'warning', '#b87a0a':'warning',
        '#c03030':'danger',  '#b52c2c':'danger',
        '#7345b0':'purple',
        '#5a6270':'neutral', '#5a6878':'neutral'
      };
      var STROKE_MAP = {
        '#155a85':'info',
        '#14693e':'success',
        '#a06508':'warning', '#946208':'warning',
        '#9a2020':'danger',  '#921e1e':'danger',
        '#5b3590':'purple',
        '#454d58':'neutral', '#47525f':'neutral'
      };

      // ── Light palette (soft pastels + hue-matched dark text) ────
      var LIGHT = {
        info:    { fill:'#d4e8f5', stroke:'#a8c8de', text:'#1a5a88' },
        success: { fill:'#d2eddf', stroke:'#a4d4bb', text:'#166e42' },
        warning: { fill:'#f5e6cc', stroke:'#e0c89a', text:'#8a5500' },
        danger:  { fill:'#f5d4d4', stroke:'#dea8a8', text:'#962424' },
        purple:  { fill:'#e4d8f2', stroke:'#c4ade0', text:'#5c3890' },
        neutral: { fill:'#e2e4e8', stroke:'#c5c9d0', text:'#3a424e' }
      };
      // Dark palette (restore originals — white text on saturated fills)
      var DARK = {
        info:    { fill:'#1e6fa5', stroke:'#155a85', text:'#fff' },
        success: { fill:'#1a8a52', stroke:'#14693e', text:'#fff' },
        warning: { fill:'#b87a0a', stroke:'#946208', text:'#fff' },
        danger:  { fill:'#b52c2c', stroke:'#921e1e', text:'#fff' },
        purple:  { fill:'#7345b0', stroke:'#5b3590', text:'#fff' },
        neutral: { fill:'#5a6878', stroke:'#47525f', text:'#fff' }
      };

      // ── Helpers ─────────────────────────────────────────────────
      function rgbToHex(rgb) {
        if (!rgb || rgb === 'none' || rgb === 'transparent') return '';
        if (rgb.charAt(0) === '#') return rgb.toLowerCase();
        var m = rgb.match(/(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/);
        if (!m) return '';
        return '#' + ((1<<24) + (+m[1]<<16) + (+m[2]<<8) + +m[3]).toString(16).slice(1);
      }

      function getColor(el, prop) {
        // Prefer computed style — it reflects the FINAL applied value
        // including classDef CSS rules that override SVG fill attributes.
        // Without this, classDef fills are missed because getAttribute()
        // returns Mermaid's default fill (e.g. #ececff) not the classDef one.
        try {
          var computed = window.getComputedStyle(el)[prop];
          if (computed && computed !== 'none' && computed !== 'transparent') {
            return rgbToHex(computed);
          }
        } catch(e) {}
        var val = el.style[prop];
        if (!val || val === 'none') val = el.getAttribute(prop);
        return rgbToHex(val || '');
      }

      function isLightMode() {
        return document.body.getAttribute('data-md-color-scheme') === 'default';
      }

      // ── Get SVGs from shadow roots inside .mermaid containers ───
      function getMermaidSvgs() {
        var svgs = [];
        var containers = document.querySelectorAll('div.mermaid');
        for (var i = 0; i < containers.length; i++) {
          var sr = containers[i].shadowRoot;
          if (sr) {
            var svg = sr.querySelector('svg');
            if (svg) svgs.push(svg);
          }
        }
        return svgs;
      }

      // ── Tag one SVG: find shapes with known fills/strokes ───────
      function tagSvg(svg) {
        if (svg.hasAttribute('data-bp-tagged')) return;
        var shapes = svg.querySelectorAll('.node rect, .node circle, .node polygon, .node path, .node .label-container');
        for (var i = 0; i < shapes.length; i++) {
          var el = shapes[i];
          if (el.hasAttribute('data-bp-group')) continue;
          var fill = getColor(el, 'fill');
          if (fill && FILL_MAP[fill]) {
            el.setAttribute('data-bp-fill', fill);
            el.setAttribute('data-bp-group', FILL_MAP[fill]);
          }
          var stroke = getColor(el, 'stroke');
          if (stroke && STROKE_MAP[stroke]) {
            el.setAttribute('data-bp-stroke', stroke);
            if (!el.hasAttribute('data-bp-group')) {
              el.setAttribute('data-bp-group', STROKE_MAP[stroke]);
            }
          }
        }
        var styled = svg.querySelectorAll('[style]');
        for (var j = 0; j < styled.length; j++) {
          var s = styled[j];
          if (s.hasAttribute('data-bp-group')) continue;
          var sf = rgbToHex(s.style.fill || '');
          if (sf && FILL_MAP[sf]) {
            s.setAttribute('data-bp-fill', sf);
            s.setAttribute('data-bp-group', FILL_MAP[sf]);
          }
          var ss = rgbToHex(s.style.stroke || '');
          if (ss && STROKE_MAP[ss]) {
            s.setAttribute('data-bp-stroke', ss);
            if (!s.hasAttribute('data-bp-group')) {
              s.setAttribute('data-bp-group', STROKE_MAP[ss]);
            }
          }
        }
        svg.setAttribute('data-bp-tagged', '1');
      }

      // ── Apply light or dark palette to one SVG ──────────────────
      function applySvgTheme(svg) {
        var light = isLightMode();
        var pal = light ? LIGHT : DARK;
        var tagged = svg.querySelectorAll('[data-bp-group]');
        for (var i = 0; i < tagged.length; i++) {
          var el = tagged[i];
          var group = el.getAttribute('data-bp-group');
          var colors = pal[group];
          if (!colors) continue;
          el.style.fill = colors.fill;
          if (el.hasAttribute('data-bp-stroke')) {
            el.style.stroke = colors.stroke;
          }
          var node = el.closest('.node') || el.parentElement;
          if (node) {
            var labels = node.querySelectorAll('.nodeLabel');
            for (var k = 0; k < labels.length; k++) {
              labels[k].style.setProperty('color', colors.text, 'important');
            }
          }
        }
        // Subtitle nodes
        var subs = svg.querySelectorAll('.subtitle .nodeLabel, [class*="subtitle"] .nodeLabel');
        for (var m = 0; m < subs.length; m++) {
          subs[m].style.setProperty('color', light ? '#4a5260' : '#fff', 'important');
        }
      }

      // ── Process all Mermaid SVGs (via shadow roots) ─────────────
      function processAll() {
        var svgs = getMermaidSvgs();
        for (var i = 0; i < svgs.length; i++) {
          tagSvg(svgs[i]);
          applySvgTheme(svgs[i]);
        }
      }

      function processAllFresh() {
        var svgs = getMermaidSvgs();
        for (var i = 0; i < svgs.length; i++) {
          svgs[i].removeAttribute('data-bp-tagged');
        }
        processAll();
      }

      // ── Observers ───────────────────────────────────────────────
      // Theme toggle
      new MutationObserver(function(muts) {
        for (var i = 0; i < muts.length; i++) {
          if (muts[i].attributeName === 'data-md-color-scheme') {
            processAll();
          }
        }
      }).observe(document.body, { attributes: true, attributeFilter: ['data-md-color-scheme'] });

      // DOM changes — catch Mermaid containers appearing
      new MutationObserver(function() {
        processAll();
      }).observe(document.documentElement, { childList: true, subtree: true });

      // Material SPA navigation
      if (typeof document$ !== 'undefined') {
        document$.subscribe(function() {
          setTimeout(processAllFresh, 200);
          setTimeout(processAllFresh, 800);
          setTimeout(processAllFresh, 2000);
        });
      }

      // Initial run with retries for async Mermaid rendering
      processAll();
      setTimeout(processAll, 500);
      setTimeout(processAll, 1500);
      setTimeout(processAll, 4000);
    })();
  </script>

  {% if page and page.meta.get("comments", true) != false %}
  <!-- Share Buttons -->
  <div class="bp-share" id="bp-share">
    <span class="bp-share-label">Share this page</span>
    <div class="bp-share-links">
      <a href="https://twitter.com/intent/tweet?text={{ page.title | urlencode }}%20%E2%80%94%20Blueprint%20for%20an%20AI-First%20Company&url={{ page.canonical_url | urlencode }}&via=sauravbhats"
         target="_blank" rel="noopener" class="bp-share-btn" title="Share on X">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        Share on X
      </a>
      <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ page.canonical_url | urlencode }}"
         target="_blank" rel="noopener" class="bp-share-btn" title="Share on LinkedIn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
        LinkedIn
      </a>
      <a href="https://news.ycombinator.com/submitlink?u={{ page.canonical_url | urlencode }}&t={{ page.title | urlencode }}%20%E2%80%94%20Blueprint%20for%20an%20AI-First%20Company"
         target="_blank" rel="noopener" class="bp-share-btn" title="Submit to Hacker News">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M0 0v24h24V0H0zm12.3 13.54l-3.78-7.2h1.76l2.79 5.56 2.84-5.56h1.7l-3.8 7.2v4.76h-1.51v-4.76z"/></svg>
        Hacker News
      </a>
    </div>
  </div>

  <!-- CTA Banner -->
  <div class="bp-cta-banner">
    <span class="bp-cta-label">Found this useful?</span>
    <div class="bp-cta-actions">
      <a href="https://github.com/saurav-yirifi/blueprint-ai-first-company"
         class="bp-cta-action" id="bp-star-btn"
         onclick="event.preventDefault();window.open(this.href,'github-star','width=1024,height=600,scrollbars=yes,resizable=yes');">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        Star on GitHub
      </a>
      <a href="#bp-share" class="bp-cta-action">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        Share it
      </a>
      <a href="#__comments" class="bp-cta-action">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Join the discussion
      </a>
    </div>
  </div>

  <!-- Giscus Comments -->
  <h2 id="__comments">Discussion</h2>

  <script>
    // FIX #4: Set Giscus theme dynamically BEFORE it loads
    (function() {
      var scheme = document.body.getAttribute('data-md-color-scheme');
      var base = 'https://aiblueprint.saurav.ai/stylesheets/';
      var theme = scheme === 'default' ? base + 'giscus-light.css' : base + 'giscus-dark.css';

      var s = document.createElement('script');
      s.src = 'https://giscus.app/client.js';
      s.setAttribute('data-repo', 'saurav-yirifi/blueprint-ai-first-company');
      s.setAttribute('data-repo-id', 'R_kgDORKaefw');
      s.setAttribute('data-category', 'General');
      s.setAttribute('data-category-id', 'DIC_kwDORKaef84C2Dbx');
      s.setAttribute('data-mapping', 'pathname');
      s.setAttribute('data-strict', '0');
      s.setAttribute('data-reactions-enabled', '1');
      s.setAttribute('data-emit-metadata', '0');
      s.setAttribute('data-input-position', 'top');
      s.setAttribute('data-theme', theme);
      s.setAttribute('data-lang', 'en');
      s.setAttribute('data-loading', 'lazy');
      s.setAttribute('crossorigin', 'anonymous');
      s.async = true;
      document.currentScript.parentElement.appendChild(s);
    })();
  </script>

  <script>
    // Sync Giscus theme on palette toggle
    (function() {
      function getGiscusTheme() {
        var scheme = document.body.getAttribute('data-md-color-scheme');
        var base = 'https://aiblueprint.saurav.ai/stylesheets/';
        return scheme === 'default' ? base + 'giscus-light.css' : base + 'giscus-dark.css';
      }

      var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(m) {
          if (m.attributeName === 'data-md-color-scheme') {
            var frame = document.querySelector('.giscus-frame');
            if (frame) {
              frame.contentWindow.postMessage(
                { giscus: { setConfig: { theme: getGiscusTheme() } } },
                'https://giscus.app'
              );
            }
          }
        });
      });
      observer.observe(document.body, { attributes: true, attributeFilter: ['data-md-color-scheme'] });
    })();
  </script>
  {% endif %}
{% endblock %}
